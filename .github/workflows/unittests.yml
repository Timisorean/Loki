name: Googletest Unit Tests

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Loki
      uses: actions/checkout@v2

    - name: Checkout Google Test
      uses: actions/checkout@v2
      with:
        repository: google/googletest
        path: 'googletest'
        ref: 'dddb219c3eb96d7f9200f09b0a381f016e6b4562'  # stick to a commit to avoid added future dependencies

    - name: Cache Google Test
      id: cache-googletest
      uses: actions/cache@v2
      with:
        path: |
          googletest-install
        key: ${{ runner.os }}-googletest-${{ hashFiles('**/googletest/CMakeLists.txt') }}  # Unique key based on OS and CMake file

    - name: Build and Install Google Test
      if: steps.cache-googletest.outputs.cache-hit != 'true'
      run: |
        cd googletest
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBENCHMARK_ENABLE_GTEST_TESTS=OFF -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/googletest-install"
        cmake --build build
        cmake --install build

    - name: Download and extract boost, no building required
      run: |
        wget --no-check-certificate 'https://archives.boost.io/release/1.84.0/source/boost_1_84_0.tar.gz'
        tar xf boost_1_84_0.tar.gz

    - name: Configure CMake
      run: cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_TESTING:BOOL=TRUE -DCMAKE_PREFIX_PATH="$GITHUB_WORKSPACE/googletest-install;$GITHUB_WORKSPACE/boost_1_84_0" -S . -B build

    - name: Build Loki
      run: export CXXFLAGS="-Werror" && cmake --build build

    - name: Test
      working-directory: build/tests/unit
      run: GTEST_OUTPUT=xml:test-results/ GTEST_COLOR=1 ctest -V
